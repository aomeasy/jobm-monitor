# .github/workflows/jobm-monitor.yml
name: ğŸ¤– JobM Monitor

on:
  schedule:
    # à¸£à¸±à¸™à¸—à¸¸à¸à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡ à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆ 8:00-17:00 à¸™. à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œ-à¸¨à¸¸à¸à¸£à¹Œ (à¹€à¸§à¸¥à¸²à¹„à¸—à¸¢)
    - cron: '0 1-10 * * 1-5'  # 08:00-17:00 ICT = 01:00-10:00 UTC
  
  workflow_dispatch:  # à¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸±à¸™à¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡à¹„à¸”à¹‰
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Bangkok

jobs:
  monitor:
    name: ğŸ” Monitor JobM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸŒ Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --no-cache-dir -r requirements.txt

    - name: ğŸ”‘ Setup Google Credentials
      env:
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "$GOOGLE_SERVICE_ACCOUNT_JSON" | base64 -d > service_account.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=service_account.json" >> $GITHUB_ENV

    - name: ğŸš€ Run JobM Monitor
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
      run: |
        echo "ğŸ• Current time: $(date)"
        echo "ğŸŒ Timezone: $TZ"
        
        if [ "$TEST_MODE" = "true" ]; then
          echo "ğŸ§ª Running in test mode..."
          python test_monitor.py
        else
          echo "ğŸ¤– Running JobM Monitor..."
          python main.py
        fi

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        rm -f service_account.json
        rm -f *.png

    - name: ğŸ“Š Upload Error Logs
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          *.png
          *.log
        retention-days: 3
